<!DOCTYPE html>  <html> <head>   <title>connection.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="../docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="connection.html">                 connection.js               </a>                                           <a class="source" href="defaults.html">                 defaults.js               </a>                                           <a class="source" href="packetBuilder.html">                 packetBuilder.js               </a>                                           <a class="source" href="responseParser.html">                 responseParser.js               </a>                                           <a class="source" href="rowParser.html">                 rowParser.js               </a>                                           <a class="source" href="tds.html">                 tds.js               </a>                                           <a class="source" href="typeParser.html">                 typeParser.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">       <ul>        <li>         <a href="../chart/tds_chart.html">tds modul structure (overview)</a>        </li>       </ul>             <h1>               connection.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h3>Author: <span> H.Ristau</span><a id="top"></a></h3>

<p>Provides a connection to a SQL Server.</p>

<h4>requires:</h4>

<ul>
<li>net</li>
<li>util</li>
<li>events</li>
<li><a href="./packetBuilder.html">packetBuilder.js</a></li>
<li><a href="./responseParser.html">responseParser.js</a></li>
</ul>

<h3>functions:</h3>

<ul>
<li><a href="#receiveData">receiveData(data, callback)</a></li>
<li><a href="#setParseDbResponseResult">setParseDbResponseResult(parseResult)</a></li>
<li><a href="#connect">connect()</a></li>
<li><a href="#executeQuery">executeQuery(query, callback)</a></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">net</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;net&#39;</span><span class="p">);</span>
<span class="c1">//var assert = require(&#39;assert&#39;);</span>
<span class="kd">var</span> <span class="nx">packetBuilder</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/packetBuilder.js&#39;</span><span class="p">).</span><span class="nx">packetBuilder</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">EventEmitter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">).</span><span class="nx">EventEmitter</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">ResponseParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/responseParser.js&#39;</span><span class="p">);</span>


<span class="kd">var</span> <span class="nx">Connection</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">config</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">config</span> <span class="o">=</span> <span class="nx">config</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stream</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Socket</span><span class="p">(</span>
    <span class="p">{</span>
      <span class="nx">allowHalfOpen</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">packetArr</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> </pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>only for info </p>             </td>             <td class="code">               <div class="highlight"><pre>

    <span class="k">this</span><span class="p">.</span><span class="nx">lastPacket</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">packetState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">packetLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">packetComplete</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">encoding</span> <span class="o">=</span> <span class="s1">&#39;utf8&#39;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">isConnected</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">sqlErrNo</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;&#39;</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">responseParser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ResponseParser</span><span class="p">();</span>
  <span class="p">};</span>


<span class="nx">util</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">Connection</span><span class="p">,</span> <span class="nx">EventEmitter</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">Connection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p><a href="#top">top</a>  <a id="receiveData" /></p>

<h2>function Connection.receiveData</h2>

<h3>Parameter:</h3>

<ul>
<li>data <em>buffer</em></li>
<li>callback <em>function</em></li>
</ul>

<p>receivesData is called when the data event of the Connection is fired
the function handels full tds packtes or chunks of them
tds packets will be stored in Connection.packetArr
the callback function needs the two parameters, error and result</p>             </td>             <td class="code">               <div class="highlight"><pre>

<span class="nx">p</span><span class="p">.</span><span class="nx">receiveData</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>
<span class="p">{</span>

  <span class="kd">var</span> <span class="nx">dataOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">copyLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>loop over data buffer </p>             </td>             <td class="code">               <div class="highlight"><pre>

  <span class="k">while</span><span class="p">(</span><span class="nx">dataOffset</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
  <span class="p">{</span>


    <span class="c1">//console.log(&#39;dataOffset:&#39;+dataOffset);</span>
    </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>next package or next chunk </p>             </td>             <td class="code">               <div class="highlight"><pre>

    <span class="k">if</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">packetComplete</span><span class="p">)</span>
    <span class="p">{</span>

      </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>first chunk of next packet </p>             </td>             <td class="code">               <div class="highlight"><pre>

      <span class="nx">self</span><span class="p">.</span><span class="nx">channel</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">readUInt16BE</span><span class="p">(</span><span class="nx">dataOffset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

      </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>read the packet length </p>             </td>             <td class="code">               <div class="highlight"><pre>

      <span class="nx">self</span><span class="p">.</span><span class="nx">packetLen</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">readUInt16BE</span><span class="p">(</span><span class="nx">dataOffset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

      </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>calculate the length to copy </p>             </td>             <td class="code">               <div class="highlight"><pre>

      <span class="k">if</span><span class="p">((</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">dataOffset</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">packetLen</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">copyLen</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">packetLen</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="nx">copyLen</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">dataOffset</span><span class="p">;</span>
      <span class="p">}</span>

      </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>craete new element in packet array </p>             </td>             <td class="code">               <div class="highlight"><pre>

      <span class="nx">self</span><span class="p">.</span><span class="nx">packetArr</span><span class="p">[</span><span class="nx">self</span><span class="p">.</span><span class="nx">packetArr</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">packetLen</span><span class="p">);</span>

      </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>copy data in packet array element </p>             </td>             <td class="code">               <div class="highlight"><pre>

      <span class="nx">data</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">packetArr</span><span class="p">[</span><span class="nx">self</span><span class="p">.</span><span class="nx">packetArr</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">dataOffset</span><span class="p">,</span> <span class="nx">dataOffset</span> <span class="o">+</span> <span class="nx">copyLen</span><span class="p">);</span>

      </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>read the packet state </p>             </td>             <td class="code">               <div class="highlight"><pre>

      <span class="nx">self</span><span class="p">.</span><span class="nx">packetState</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">readUInt8</span><span class="p">(</span><span class="nx">dataOffset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>set the packet complete flag </p>             </td>             <td class="code">               <div class="highlight"><pre>

      <span class="nx">self</span><span class="p">.</span><span class="nx">packetComplete</span> <span class="o">=</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">packetLen</span> <span class="o">==</span> <span class="nx">copyLen</span><span class="p">);</span> </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>calculate the new offset for the actual packet</p>             </td>             <td class="code">               <div class="highlight"><pre>

      <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">packetComplete</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">packetOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">packetOffset</span> <span class="o">+=</span> <span class="nx">copyLen</span><span class="p">);</span>

    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span> </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>next chunk of actual packet </p>             </td>             <td class="code">               <div class="highlight"><pre>


      </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>calculate the length to copy </p>             </td>             <td class="code">               <div class="highlight"><pre>

      <span class="k">if</span><span class="p">((</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">dataOffset</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">packetLen</span> <span class="o">-</span> <span class="nx">self</span><span class="p">.</span><span class="nx">packetOffset</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="nx">copyLen</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">packetLen</span> <span class="o">-</span> <span class="nx">self</span><span class="p">.</span><span class="nx">packetOffset</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="nx">copyLen</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">dataOffset</span><span class="p">;</span>
      <span class="p">}</span>

      </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>copy data in packet array element </p>             </td>             <td class="code">               <div class="highlight"><pre>

      <span class="nx">data</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">packetArr</span><span class="p">[</span><span class="nx">self</span><span class="p">.</span><span class="nx">packetArr</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="nx">self</span><span class="p">.</span><span class="nx">packetOffset</span><span class="p">,</span> <span class="nx">dataOffset</span><span class="p">,</span> <span class="nx">dataOffset</span> <span class="o">+</span> <span class="nx">copyLen</span><span class="p">);</span>

      </pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>set the packet complete flag </p>             </td>             <td class="code">               <div class="highlight"><pre>

      <span class="nx">self</span><span class="p">.</span><span class="nx">packetComplete</span> <span class="o">=</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">packetLen</span> <span class="o">==</span> <span class="nx">self</span><span class="p">.</span><span class="nx">packetOffset</span> <span class="o">+</span> <span class="nx">copyLen</span><span class="p">);</span>

      </pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>calculate the new offset for the actual packet</p>             </td>             <td class="code">               <div class="highlight"><pre>

      <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">packetComplete</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">packetOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">packetOffset</span> <span class="o">+=</span> <span class="nx">copyLen</span><span class="p">);</span>

    <span class="p">}</span> </pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>calculate the new offset for the actual data buffer </p>             </td>             <td class="code">               <div class="highlight"><pre>

    <span class="nx">dataOffset</span> <span class="o">+=</span> <span class="nx">copyLen</span><span class="p">;</span>

  <span class="p">}</span> <span class="c1">//while</span>

  </pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>when packet is complete the parsing has to start </p>             </td>             <td class="code">               <div class="highlight"><pre>

  <span class="k">if</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">packetComplete</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">packetState</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span>
  <span class="p">{</span>
    </pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>parse the DB response packet </p>             </td>             <td class="code">               <div class="highlight"><pre>

    <span class="kd">var</span> <span class="nx">parseResult</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">responseParser</span><span class="p">.</span><span class="nx">parseDbResponse</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">packetArr</span><span class="p">);</span> </pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>copy the parsing result </p>             </td>             <td class="code">               <div class="highlight"><pre>

    <span class="nx">self</span><span class="p">.</span><span class="nx">setParseDbResponseResult</span><span class="p">(</span><span class="nx">parseResult</span><span class="p">);</span>

    </pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>finally call callback with the parsing result </p>             </td>             <td class="code">               <div class="highlight"><pre>

    <span class="nx">callback</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">result</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>

    </pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>delete raw data </p>             </td>             <td class="code">               <div class="highlight"><pre>

    <span class="k">this</span><span class="p">.</span><span class="nx">packetArr</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>

    </pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>packet is complete </p>             </td>             <td class="code">               <div class="highlight"><pre>

    <span class="k">return</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span> </pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>packet is not complete </p>             </td>             <td class="code">               <div class="highlight"><pre>

    <span class="k">return</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

</pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p><a href="#top">top</a>  <a id="setParseDbResponseResult" /></p>

<h2>function Connection.setParseDbResponseResult</h2>

<h3>Parameter:</h3>

<ul>
<li>parseResult <em>object</em></li>
</ul>

<p>copies parseResulte in the scope of the connection object</p>             </td>             <td class="code">               <div class="highlight"><pre>

<span class="nx">p</span><span class="p">.</span><span class="nx">setParseDbResponseResult</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">parseResult</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">result</span> <span class="o">=</span> <span class="nx">parseResult</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="nx">parseResult</span><span class="p">.</span><span class="nx">error</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">parseResult</span><span class="p">.</span><span class="nx">isConnected</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">isConnected</span> <span class="o">=</span> <span class="nx">parseResult</span><span class="p">.</span><span class="nx">isConnected</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p><a href="#top">top</a>  <a id="close" /></p>

<h2>function Connection.close</h2>

<p>close the stream of the connection</p>             </td>             <td class="code">               <div class="highlight"><pre>

<span class="nx">p</span><span class="p">.</span><span class="nx">close</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span>
<span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
<span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p><a href="#top">top</a>  <a id="connect" /></p>

<h2>function Connection.connect</h2>

<p>open a stream and force a login request</p>             </td>             <td class="code">               <div class="highlight"><pre>

<span class="nx">p</span><span class="p">.</span><span class="nx">connect</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span>
<span class="p">{</span>
  <span class="c1">//p.connect = function(port, host) {</span>
  </pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>check stream state. Open the stream when state is closed. </p>             </td>             <td class="code">               <div class="highlight"><pre>

  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="s1">&#39;closed&#39;</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">ConnectionString</span><span class="p">.</span><span class="nx">Port</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">ConnectionString</span><span class="p">.</span><span class="nx">Server</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="s1">&#39;open&#39;</span><span class="p">)</span>
  <span class="p">{</span> </pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>stream is already open </p>             </td>             <td class="code">               <div class="highlight"><pre>

    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">waitOnDrain</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;drain&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span>
  <span class="p">{</span>
    <span class="nx">waitOnDrain</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">});</span>

  </pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>register a function for login on the connect event of the stream </p>             </td>             <td class="code">               <div class="highlight"><pre>

  <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span>
  <span class="p">{</span> </pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>create a packet for a login request </p>             </td>             <td class="code">               <div class="highlight"><pre>

    <span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="nx">packetBuilder</span><span class="p">.</span><span class="nx">LoginRequest</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">ConnectionString</span><span class="p">.</span><span class="nx">Login</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">ConnectionString</span><span class="p">.</span><span class="nx">Password</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">ConnectionString</span><span class="p">.</span><span class="nx">Database</span><span class="p">);</span>

    </pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>send the login request </p>             </td>             <td class="code">               <div class="highlight"><pre>

    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>

  <span class="p">});</span> </pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>register a function on the data event of the stream object to handle the DB response. </p>             </td>             <td class="code">               <div class="highlight"><pre>


  <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">isConnected</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">receiveData</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span>
    <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">isConnected</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">);</span>
      <span class="p">}</span>

    <span class="p">});</span>


  <span class="p">});</span>

  </pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>register a function on the error event of the stream object </p>             </td>             <td class="code">               <div class="highlight"><pre>

  <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;error: &#39;</span> <span class="o">+</span> <span class="nx">error</span><span class="p">);</span>
  <span class="p">});</span>

<span class="p">};</span>

</pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p><a href="#top">top</a>  <a id="executeQuery" /></p>

<h2>function Connection.executeQuery</h2>

<h3>Parameter:</h3>

<ul>
<li>query <em>string</em></li>
<li>callback <em>function</em></li>
</ul>

<p>force a exectuion of a query. The callback function will be pass to <a href="#receiveData">receiveData</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>


<span class="nx">p</span><span class="p">.</span><span class="nx">executeQuery</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>
<span class="p">{</span>


  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isConnected</span><span class="p">)</span>
  <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">buff</span> <span class="o">=</span> <span class="nx">packetBuilder</span><span class="p">.</span><span class="nx">ExecuteQuery</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">receiveData</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">===</span> <span class="kc">false</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">ret</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">removeAllListeners</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">);</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">);</span>
      <span class="p">}</span>

    <span class="p">});</span>


    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">buff</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">buff</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="c1">//done</span>
  <span class="p">}</span>

<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Connection</span><span class="p">;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 